<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>EXPO 空きチェック</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    label { display: block; margin-top: 1rem; }
    select, input { margin-top: 0.5rem; padding: 0.5rem; width: 100%; }
    button { margin-top: 2rem; padding: 1rem; width: 100%; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 1rem; }
    .result { margin-top: 2rem; color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h1>EXPO 空き状況チェッカー</h1>

  <label>あなたのID:
    <input type="text" id="userId" placeholder="例: XXXXXX">
  </label>

  <label>希望開始時間（24h形式）:
    <input type="number" id="startHour" min="0" max="23">
  </label>

  <label>希望終了時間（24h形式）:
    <input type="number" id="endHour" min="1" max="24">
  </label>

  <label>希望パビリオン 第1希望:
    <select id="pavilion1"></select>
  </label>
  <label>希望パビリオン 第2希望:
    <select id="pavilion2"></select>
  </label>
  <label>希望パビリオン 第3希望:
    <select id="pavilion3"></select>
  </label>
  <label>希望パビリオン 第4希望:
    <select id="pavilion4"></select>
  </label>
  <label>希望パビリオン 第5希望:
    <select id="pavilion5"></select>
  </label>

  <button onclick="startChecking()">空きチェック開始</button>

  <div class="result" id="status"></div>

  <script>
    const GAS_PROXY_URL = "https://script.google.com/macros/s/AKfycbx1juj23u8znVKq8WCyFA9gcCcPX-uhGun6DVz4B2Dd2dvnagMQHj24Pby8dEAkssPu/exec";
    const RESERVE_BASE_URL = "https://ticket.expo2025.or.jp/event_time/?id=USERID&event_id=EVENTID&entrance_date=DATE";

    // 保存データ復元
    window.onload = () => {
      loadSavedSettings();
      fetchPavilionList();
    };

    // 入力内容を保存
    function saveSettings() {
      const settings = {
        userId: document.getElementById("userId").value,
        startHour: document.getElementById("startHour").value,
        endHour: document.getElementById("endHour").value,
        pavilions: [
          document.getElementById("pavilion1").value,
          document.getElementById("pavilion2").value,
          document.getElementById("pavilion3").value,
          document.getElementById("pavilion4").value,
          document.getElementById("pavilion5").value,
        ]
      };
      localStorage.setItem("expoSettings", JSON.stringify(settings));
    }

    function loadSavedSettings() {
      const saved = JSON.parse(localStorage.getItem("expoSettings"));
      if (!saved) return;
      document.getElementById("userId").value = saved.userId || "";
      document.getElementById("startHour").value = saved.startHour || "";
      document.getElementById("endHour").value = saved.endHour || "";
    }

    async function fetchPavilionList() {
      try {
        const res = await fetch(GAS_PROXY_URL);
        const data = await res.json();
        const selects = ["pavilion1", "pavilion2", "pavilion3", "pavilion4", "pavilion5"];
        selects.forEach(id => {
          const sel = document.getElementById(id);
          sel.innerHTML = "<option value=''>--選択してください--</option>";
          data.forEach(p => {
            if (p.n) sel.innerHTML += `<option value="${p.c}">${p.n}</option>`;
          });
        });
        // saved pavilions (after options loaded)
        const saved = JSON.parse(localStorage.getItem("expoSettings"));
        if (saved && saved.pavilions) {
          saved.pavilions.forEach((val, idx) => {
            if (val) document.getElementById(selects[idx]).value = val;
          });
        }
      } catch (e) {
        document.getElementById("status").textContent = "パビリオン取得失敗";
      }
    }

    async function startChecking() {
      saveSettings();
      document.getElementById("status").textContent = "監視開始...";

      const userId = document.getElementById("userId").value;
      const startHour = parseInt(document.getElementById("startHour").value);
      const endHour = parseInt(document.getElementById("endHour").value);
      const pavilions = ["pavilion1", "pavilion2", "pavilion3", "pavilion4", "pavilion5"].map(id => document.getElementById(id).value).filter(Boolean);

      const loop = async () => {
        try {
          const res = await fetch(GAS_PROXY_URL);
          const data = await res.json();
          for (const item of data) {
            if (item.s && item.s.length > 0 && pavilions.includes(item.c)) {
              const hasAvailable = item.s.some(slot => parseInt(slot.t.slice(0, 2)) >= startHour && parseInt(slot.t.slice(0, 2)) < endHour && slot.f === 1);
              if (hasAvailable) {
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, "");
                const jumpUrl = RESERVE_BASE_URL.replace("USERID", userId).replace("EVENTID", item.c).replace("DATE", today);
                window.location.href = jumpUrl;
                return;
              }
            }
          }
        } catch (e) {
          console.log("Fetch error", e);
        }
        setTimeout(loop, 1000);
      };

      loop();
    }
  </script>
</body>
</html>
