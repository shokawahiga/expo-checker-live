<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万博 当日予約 空き状況</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        p {
            text-align: center;
            color: #666;
        }
        #results {
            list-style: none;
            padding: 0;
            min-height: 50px;
            text-align: center;
            color: #666;
        }
        .entry {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-align: left;
        }
        .entry:last-child {
            border-bottom: none;
        }
        .entry a {
            color: green;
            font-weight: bold;
            text-decoration: none;
        }
        .entry a:hover {
            text-decoration: underline;
        }
        .checkbox {
            margin-right: 10px;
            color: green;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>万博 当日予約 空き状況</h1>
        <p>3秒ごとにチェック。空きがあるパビリオンが下に表示されます。</p>
        <div id="results">
            🔄 チェック中...
        </div>
    </div>

    <script>
        const ticketId = "XSMQMPP73F";

        function getToday() {
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}${mm}${dd}`;
        }

        function formatTime(timeStr) {
            if (timeStr && timeStr.length === 4) {
                return `${timeStr.slice(0, 2)}:${timeStr.slice(2, 4)}`;
            }
            return timeStr;
        }

        async function checkAvailability() {
            const resultDiv = document.getElementById("results");
            resultDiv.innerHTML = "🔄 チェック中...";

            try {
                const res = await fetch("https://script.google.com/macros/s/AKfycbx1juj23u8znVKq8WCyFA9gcCcPX-uhGun6DVz4B2Dd2dvnagMQHj24Pby8dEAkssPu/exec");
                const json = await res.json();

                resultDiv.innerHTML = "";
                let hasAvailable = false;
                const today = getToday();

                for (const item of json) {
                    const code = item.c;
                    const name = item.n || `(コード: ${code})`;
                    const baseUrl = item.u || `https://ticket.expo2025.or.jp/event_time/?id=${ticketId}&event_id=${code}&screen_id=108&lottery=5&event_type=0&entrance_date=${today}`;

                    for (const slot of item.s || []) {
                        const time = slot.t;
                        const status = slot.s;

                        if (status >= 2) {
                            hasAvailable = true;
                            const p = document.createElement("p");
                            p.className = "entry";
                            p.innerHTML = `<span class="checkbox">✅</span> <a href="${baseUrl}" target="_blank">${name}：${formatTime(time)}（空き s=${status}）</a>`;
                            resultDiv.appendChild(p);
                        }
                    }
                }

                if (!hasAvailable) {
                    resultDiv.innerText = "❌ 空きは見つかりませんでした";
                }
            } catch (e) {
                resultDiv.innerText = "エラー：データの読み込みに失敗しました。";
                console.error(e);
            }
        }

        checkAvailability();
        setInterval(checkAvailability, 3000);
    </script>
</body>
</html>
