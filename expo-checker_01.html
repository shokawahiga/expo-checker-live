<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万博 当日予約 空き状況</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        p {
            text-align: center;
            color: #666;
        }
        #results {
            list-style: none;
            padding: 0;
            min-height: 50px; /* ロード中のメッセージやエラーメッセージが表示されるスペースを確保 */
            text-align: center; /* ロード中メッセージを中央寄せ */
            color: #666;
        }
        .entry {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* 左寄せ */
            text-align: left; /* テキスト左寄せ */
        }
        .entry:last-child {
            border-bottom: none;
        }
        .entry a {
            color: green;
            font-weight: bold;
            text-decoration: none; /* リンクの下線を削除 */
        }
        .entry a:hover {
            text-decoration: underline; /* ホバー時に下線を表示 */
        }
        .checkbox {
            margin-right: 10px;
            color: green; /* チェックマークの色 */
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>万博 当日予約 空き状況</h1>
        <p>3秒ごとにチェック。空きがあるパビリオンが下に表示されます。</p>
        <div id="results">
            🔄 チェック中...
        </div>
    </div>

    <script>
        // パビリオンコードと名称の対比表
        const pavilionNames = {
            "H1H9": "日本館 3エリア観覧",
            "HMH0": "PASONA NATUREVERSE",
            "I909": "シグネチャーパビリオン 中島さち子 「いのちの遊び場 クラゲ館」English Only 枠 車いす対応",
            "I903": "シグネチャーパビリオン 中島さち子 「いのちの遊び場 クラゲ館」車いす対応",
            "C730": "オーストラリアパビリオン 「Chasing the Sun ― 太陽の大地へ」",
            "HOH3": "ブルーオーシャンドーム(車いす)",
            "D633": "ポーランドパビリオン：ショパンコンサート（コンサートホール入場のみ）",
            "HEH6": "植林体験イベント（お子様向け）",
            "HAH0": "NTT Pavilion",
            "C7R0": "オランダパビリオン コモングラウンド",
            "HUH6": "ガスパビリオン・おばけワンダーランド/スマートデバイス",
            "HIH0": "三菱未来館 JOURNEY TO LIFE",
            "IC00": "シグネチャーパビリオン 落合陽一 「null²」ダイアログモード",
            "C2N0": "イタリアパビリオン also hosting the Holy See ～15:00",
            "C2N3": "イタリアパビリオン also hosting the Holy See 15:00～",
            "H7H3": "関西パビリオン（飲食付（有料）／ハイチェア）",
            "I906": "シグネチャーパビリオン 中島さち子 「いのちの遊び場 クラゲ館」English Only 枠",
            "H7H6": "関西パビリオン（飲食付（有料）／ローチェア（車いす対応可））",
            "H3H0": "ウーマンズ パビリオン in collaboration with Cartier",
            "CCB0": "クウェート国パビリオン",
            "IO00": "シグネチャーパビリオン 河瀨直美「Dialogue Theater - いのちのあかし -」",
            "HMH3": "PASONA NATUREVERSE 車いす対応",
            "H5H3": "大阪ヘルスケアパビリオン（本館） リボーン体験＋人生ゲームREBORN in 2050",
            "H5HC": "【車いす使用者向け】大阪ヘルスケアパビリオン(XD HALL)モンスターハンター ブリッジ",
            "I300": "シグネチャーパビリオン 宮田裕章 「Better Co-Being」",
            "C9J0": "韓国館",
            "HCH3": "電力館（車いす対応）",
            "Q013": "万博サウナ 太陽のつぼみ 90分男女混合グループ",
            "H5H9": "大阪ヘルスケアパビリオン(XD HALL)モンスターハンター ブリッジ",
            "Q010": "万博サウナ 太陽のつぼみ 90分女性",
            "Q007": "万博サウナ 太陽のつぼみ 90分男性",
            "J903": "「未来の都市」 参加型シアター入場なし",
            "HUH0": "ガスパビリオン・おばけワンダーランド/XRゴーグル(利用制限あり)",
            "I606": "シグネチャーパビリオン 石黒浩「いのちの未来」 インクルーシブ",
            "I90C": "シグネチャーパビリオン 中島さち子 「いのちの遊び場 クラゲ館」ワイワイぺちゃくちゃ枠",
            "CFR0": "国際赤十字・赤新月運動館",
            "HOH0": "ブルーオーシャンドーム",
            "HWH3": "飯田グループ×大阪公立大学共同出展館 車いす対応",
            "J900": "「未来の都市」 参加型シアター入場付き",
            "HEH0": "住友館",
            "HCH0": "電力館",
            "CO73": "タイパビリオン（障がい者用）",
            "CO70": "タイパビリオン（一般入館）",
            "I600": "シグネチャーパビリオン 石黒浩「いのちの未来」 一般",
            "I603": "シグネチャーパビリオン 石黒浩「いのちの未来」 車いす対応",
            "HWH0": "飯田グループ×大阪公立大学共同出展館",
            "IL00": "シグネチャーパビリオン 小山薫堂 「EARTH MART」",
            "HKH0": "よしもとwaraii myraii館（球体内鑑賞）",
            "CFV0": "国連パビリオン",
            "D630": "ポーランドパビリオン",
            "IO03": "シグネチャーパビリオン 河瀨直美「Dialogue Theater - いのちのあかし -」車いす席",
            "I90F": "シグネチャーパビリオン 中島さち子 「いのちの遊び場 クラゲ館」ワイワイぺちゃくちゃ枠 車いす対応",
            "I900": "シグネチャーパビリオン 中島さち子 「いのちの遊び場 クラゲ館」",
            "H7H0": "関西パビリオン",
            "IF00": "シグネチャーパビリオン 福岡伸一 「いのち動的平衡館」",
            "HQH0": "GUNDAM NEXT FUTURE PAVILION",
            "II06": "シグネチャーパビリオン 河森正治 「いのちめぐる冒険」 ANIMA! 床振動演出あり",
            "HUH3": "ガスパビリオン・おばけワンダーランド/XRゴーグル(車いす・補助犬同伴)",
            "HEH3": "住友館 車いす対応",
            "JC00": "空飛ぶクルマ ステーション",
            "H5H0": "大阪ヘルスケアパビリオン（本館） リボーン体験",
            "II03": "シグネチャーパビリオン 河森正治 「いのちめぐる冒険」 超時空シアター",
            "IF03": "シグネチャーパビリオン 福岡伸一 「いのち動的平衡館」触覚体験（視覚・聴覚に障害がある方向け）",
            "HGH0": "パナソニック館 「ノモの国」",
            "II00": "シグネチャーパビリオン 河森正治 「いのちめぐる冒険」 超時空シアター",
            "HSH0": "TECH WORLD館",
            "HIH3": "三菱未来館 JOURNEY TO LIFE 車いす対応",
            "SI09": "カーボン・リサイクル・ファクトリー内大阪ガス・メタネーション実証プラント化けるLABO（車いす用）",
            "SI06": "カーボン・リサイクル・ファクトリー内大阪ガス・メタネーション実証プラント化けるLABO（一般用）",
            "S029": "【ジュニアSDGsキャンプ】会場内ツアー",
            "IC09": "シグネチャーパビリオン 落合陽一 「null²」インスタレーションモード",
            "T40R": "Well-being経営・教育 アジェンダ2025 主催プログラム",
            "T40L": "サイエンス・テクノロジーの進展 アジェンダ2025 主催プログラム",
            "T40O": "Well-beingエコシステムの構築 アジェンダ2025 主催プログラム",
            // 未定のパビリオン（APIレスポンスのキーとして存在するが、具体的な名称やURLがないもの）
            "C570": "未定のパビリオン",
            "H1HF": "未定のパビリオン",
            "M1R7": "未定のパビリオン",
            "C930": "未定のパビリオン",
            "H1HC": "未定のパビリオン",
            "C0R3": "未定のパビリオン",
            "C0R0": "未定のパビリオン",
            "M1R4": "未定のパビリオン",
            "Q004": "未定のパビリオン",
            "S009": "未定のパビリオン",
            "M1RA": "未定のパビリオン",
            "Q001": "未定のパビリオン",
            "U013": "未定のパビリオン",
            "CM30": "未定のパビリオン",
            "IC03": "未定のパビリオン", 
            "M1RJ": "未定のパビリオン",
            "M1RD": "未定のパビリオン",
            "U016": "未定のパビリオン",
            "M1RG": "未定のパビリオン",
            "U020": "未定のパビリオン",
            "S01I": "未定のパビリオン",
            "U01C": "未定のパビリオン",
            "T213": "未定のパビリオン",
            "S00O": "未定のパビリオン",
            "S016": "未定のパビリオン",
            "U01U": "未定のパビリオン",
            "U063": "未定のパビリオン",
            "S02F": "未定のパビリオン",
            "T30X": "未定のパビリオン",
            "U01I": "未定のパビリオン",
            "T306": "未定のパビリオン",
            "U06L": "未定のパビリオン",
            "M1I1": "未定のパビリオン",
            "S01X": "未定のパビリオン",
            "M1HY": "未定のパビリオン",
            "T30R": "未定のパビリオン",
            "S01U": "未定のパビリオン",
            "I90L": "未定のパビリオン",
            "I90I": "未定のパビリオン",
            "T316": "未定のパビリオン",
            "U07C": "未定のパビリオン",
            "U08U": "未定のパビリオン",
            "U08X": "未定のパビリオン",
            "S01L": "未定のパビリオン",
            "T313": "未定のパビリオン",
            "U090": "未定のパビリオン",
            "U093": "未定のパビリオン",
            "T310": "未定のパビリオン",
            "M181": "未定のパビリオン",
            "U07F": "未定のパビリオン",
            "M184": "未定のパビリオン",
            "S019": "未定のパビリオン",
            "T303": "未定のパビリオン",
            "U096": "未定のパビリオン",
            "U07I": "未定のパビリオン",
            "T30I": "未定のパビリオン",
            "U07O": "未定のパビリオン",
            "T30L": "未定のパビリオン",
            "U07L": "未定のパビリオン",
            "T30O": "未定のパビリオン",
            "U086": "未定のパビリオン",
            "M1SP": "未定のパビリオン",
            "T30C": "未定のパビリオン",
            "U07R": "未定のパビリオン",
            "T309": "未定のパビリオン",
            "U07U": "未定のパビリオン",
            "T30F": "未定のパビリオン",
            "M18S": "未定のパビリオン",
            "M18V": "未定のパビリオン",
            "U099": "未定のパビリオン",
            "U08C": "未定のパビリオン",
            "U089": "未定のパビリオン",
            "M1WA": "未定のパビリオン",
            "M1WM": "未定のパビリオン",
            "M1WG": "未定のパビリオン",
            "M1WP": "未定のパビリオン",
            "M1WJ": "未定のパビリオン",
            "M1WD": "未定のパビリオン",
            "S01O": "未定のパビリオン",
            "U09C": "未定のパビリオン",
            "M1WS": "未定のパビリオン",
            "U08F": "未定のパビリオン",
            "T40U": "未定のパビリオン",
            "T40X": "未定のパビリオン",
            "U08I": "未定のパビリオン",
            "T400": "未定のパビリオン",
            "U09I": "未定のパビリオン",
            "T41C": "未定のパビリオン",
            "T416": "未定のパビリオン",
            "S013": "未定のパビリオン",
            "O001": "未定のパビリオン",
            "U08L": "未定のパビリオン",
            "T419": "未定のパビリオン",
            "T40I": "未定のパビリオン",
            "U08O": "未定のパビリオン",
            "S01C": "未定のパビリオン",
            "T410": "未定のパビリオン",
            "T429": "未定のパビリオン",
            "T403": "未定のパビリオン",
            "S01R": "未定のパビリオン",
            "T413": "未定のパビリオン",
            "T420": "未定のパビリオン",
            "U029": "未定のパビリオン",
            "T423": "未定のパビリオン",
            "T42I": "未定のパビリオン",
            "T426": "未定のパビリオン",
            "M1QP": "未定のパビリオン",
            "M1QS": "未定のパビリオン",
            "T42C": "未定のパビリオン",
            "T41R": "未定のパビリオン",
            "M1QA": "未定のパビリオン",
            "T42F": "未定のパビリオン",
            "M1QG": "未定のパビリオン",
            "M1QM": "未定のパビリオン",
            "M1QY": "未定のパビリオン",
            "M1QV": "未定のパビリオン",
            "M1Q7": "未定のパビリオン",
            "M1QD": "未定のパビリオン",
            "M1QJ": "未定のパビリオン"
        };

        // 👇 チケットIDは自分の予約リンクから取得して設定（例：7U7WA5WS54）
        const ticketId = "XSMQMPP73F"; // あなたの実際のチケットIDに置き換えてください

        // 👇 本日の日付をYYYYMMDD 形式で取得
        function getToday() {
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}${mm}${dd}`;
        }

        // 時間をHHMMからHH:MM形式に変換するヘルパー関数
        function formatTime(timeStr) {
            if (timeStr && timeStr.length === 4) {
                return `${timeStr.slice(0, 2)}:${timeStr.slice(2, 4)}`;
            }
            return timeStr; // フォーマットできない場合はそのまま返す
        }

        async function checkAvailability() {
            const resultDiv = document.getElementById("results");
            resultDiv.innerHTML = "🔄 チェック中..."; // チェック中は常にこのメッセージ

            try {
                // ここはプロキシサーバーを使用する場合のパスです
                // もし直接APIにアクセスしたいのであれば、
                // const res = await fetch("https://expo.ebii.net/api/add"); に戻してください。
                // ただし、CORSエラーが出る可能性が高いです。
                const res = await fetch("https://script.google.com/macros/s/AKfycbx1juj23u8znVKq8WCyFA9gcCcPX-uhGun6DVz4B2Dd2dvnagMQHj24Pby8dEAkssPu/exec"); 
                const json = await res.json(); // APIレスポンスを受け取る

                resultDiv.innerHTML = ""; // 結果表示エリアをクリア

                let hasAvailable = false;
                const today = getToday(); // 今日の日付を一度だけ取得

                // APIレスポンスが「パビリオンコードをキーとするオブジェクト」の場合に対応
                if (typeof json === 'object' && json !== null && !Array.isArray(json)) { 
                    Object.entries(json).forEach(([pavilionCode, slots]) => {
                        // slots は [{"t":"HHMM", "s":残数}, ...] の配列

                        // 空きスロット（s）がある場合のみ処理
                        if (Array.isArray(slots) && slots.length > 0) {
                            slots.forEach(slot => {
                                if (slot.s > 0) { // 残数（s）が0より大きい場合
                                    hasAvailable = true;

                                    // 予約リンクの構築 (ticketIdとevent_id (c) を使用)
                                    const linkUrl = `https://ticket.expo2025.or.jp/event_time/?id=${ticketId}&event_id=${pavilionCode}&screen_id=108&lottery=5&keyword=&event_type=0&reserve_id=&entrance_date=${today}`;
                                    
                                    const p = document.createElement("p");
                                    p.className = "entry";
                                    
                                    // パビリオン名 (APIからはnが返されないので、pavilionNamesから取得、なければコードを表示)
                                    const displayTitle = pavilionNames[pavilionCode] || `(コード: ${pavilionCode})`;
                                    const formattedTime = formatTime(slot.t);

                                    p.innerHTML = `<span class="checkbox">✅</span> <a href="${linkUrl}" target="_blank">${displayTitle}：${formattedTime}（残${slot.s}）</a>`;
                                    resultDiv.appendChild(p);
                                }
                            });
                        }
                    });
                } else {
                    // APIレスポンスが期待される形式ではない場合 (例: 直接配列が返ってきた、または全く別の形式)
                    resultDiv.innerText = "エラー：APIデータが予期せぬ形式です。コンソールで詳細を確認してください。";
                    console.error("API Response is not in expected object format (top-level is not an object):", json);
                    return; // これ以上処理を進めない
                }

                if (!hasAvailable) {
                    resultDiv.innerText = "❌ 空きは見つかりませんでした";
                }
            } catch (e) {
                resultDiv.innerText = "エラー：データの読み込みに失敗しました。詳細をコンソールで確認してください。";
                console.error("Fetch Error (network or JSON parse error):", e); // エラーの種類をより具体的に
            }
        }

        // 初回と、3秒おきにチェック
        checkAvailability();
        setInterval(checkAvailability, 3000);
    </script>
</body>
</html>